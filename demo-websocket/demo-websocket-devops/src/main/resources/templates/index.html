<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8">
  <title>æœåŠ¡æ§åˆ¶å°</title>
  <link type="text/css" rel="stylesheet" th:href="@{/static/css/style.css}" />
<!--  <link type="text/css" rel="stylesheet" href="../static/css/style.css" />-->
  <script type="text/javascript" th:src="@{/static/js/jquery-1.11.1.min.js}"></script>
<!--  <script type="text/javascript" src="../static/js/jquery-1.11.1.min.js"></script>-->
</head>

<body>
  <div class="command-head">
    <div class="command-head-left">
      <label for="text">æ¶ˆæ¯:</label>
      <input id="text" type="text" name="message" />
      <button onclick="send()">å‘é€æ¶ˆæ¯</button>
      <button onclick="closeWebSocket()">å…³é—­WebSocketè¿æ¥</button>
      <!--<button onclick="getData()">ç‚¹å‡»è·å–æ•°æ®</button> -->
    </div>
    <div class="command-head-right">
      <span style="margin-right: 10px">
        <img th:src="@{/static/images/avatar.jpg}" alt="å¤´åƒ" />
      </span>
      <div style="display: flex">
        <p>Welcome | </p>&nbsp;&nbsp;<h4 th:text="${userId}"></h4>
        <input th:value="${userId}" id="userId" type="hidden">
      </div>
    </div>
  </div>
  <hr />
  <div class="main">
    <div class="sidebar">
      <ul>
        <li>
          <span>ğŸ›¢ï¸ åç«¯æœåŠ¡</span>
          <hr />
          <div class="branch">
            <label>é€‰æ‹©ç¯å¢ƒ : </label>
            <select class="branch-select" name="digital-back">
              <option value="dev">dev</option>
              <option value="aliyun">aliyun</option>
              <option value="prod">prod</option>
              <option value="beijing">beijing</option>
              <option value="preview">preview</option>
            </select>
          </div>
          <span>
            <button onclick="runApp('digital-back')" data='deploy'>å‘å¸ƒ</button>
            <button onclick="runApp('digital-back')" data='restart'>é‡å¯</button>
            <button onclick="runApp('digital-back')" data='stop'>åœæ­¢</button>
          </span>
        </li>
        <li>
          <span>ğŸ’» å‰ç«¯Web</span>
          <hr />
          <div class="branch">
            <label>é€‰æ‹©ç¯å¢ƒ : </label>
            <select class="branch-select" name="digital-web">
              <option value="dev">dev</option>
              <option value="aliyun">aliyun</option>
              <option value="prod">prod</option>
              <option value="beijing">beijing</option>
              <option value="preview">preview</option>
            </select>
          </div>
          <span>
            <button onclick="runApp('digital-web')">å‘å¸ƒ</button>
          </span>
        </li>
        <li>
          <span>ğŸ“± å‰ç«¯App</span>
          <hr />
          <div class="branch">
            <label>é€‰æ‹©ç¯å¢ƒ : </label>
            <select class="branch-select" name="digital-app">
              <option value="dev">dev</option>
              <option value="aliyun">aliyun</option>
              <option value="prod">prod</option>
              <option value="beijing">beijing</option>
              <option value="preview">preview</option>
            </select>
          </div>
          <span>
            <button onclick="runApp('digital-app')">å‘å¸ƒ</button>
          </span>
        </li>
      </ul>
    </div>
    <div class="message" id="message"></div>
  </div>
</body>
<script type="text/javascript">
  let websocket = null;
  let div = document.getElementById('message')
  //åˆ¤æ–­å½“å‰æµè§ˆå™¨æ˜¯å¦æ”¯æŒWebSocket
  if ('WebSocket' in window) {
    //æ”¹æˆä½ çš„åœ°å€
    var userId = document.querySelector("#userId").value;
    console.log("userId: ", userId)
    websocket = new WebSocket(`ws://127.0.0.1:8080/api/websocket/${userId}`);
    console.log(websocket.readyState);
    /**
     *  websocket å‰ç«¯çš„æ¯”è¾ƒæˆç†Ÿçš„åç«¯å®ç°åº“:
     *  > websocket-node (å¯ä»¥å®ç°æ•°æ®åº“)
     *  > socket.io (å®ç°äº†å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯)
     * -------------------------------------------------------
     * readState çŠ¶æ€æœ‰å››ç§:
     *  > connecting(0)
     *  > open(1)
     *  > closing(2)
     *  > closed(3)
    */
  } else {
    alert('å½“å‰æµè§ˆå™¨ Not support websocket')
  }

  //è¿æ¥å‘ç”Ÿé”™è¯¯çš„å›è°ƒæ–¹æ³•
  websocket.onerror = function () {
    setMessageInnerHTML("WebSocketè¿æ¥å‘ç”Ÿé”™è¯¯");
  };

  //è¿æ¥æˆåŠŸå»ºç«‹çš„å›è°ƒæ–¹æ³•
  websocket.onopen = function () {
    setMessageInnerHTML("WebSocketè¿æ¥æˆåŠŸ");
    console.log(websocket.readyState);
  }

  //æ¥æ”¶åˆ°æ¶ˆæ¯çš„å›è°ƒæ–¹æ³•
  websocket.onmessage = function (event) {
    console.log(event);
    data = handleMessage(event.data);
    setMessageInnerHTML("> " + data);
    //setechart()
  }

  //è¿æ¥å…³é—­çš„å›è°ƒæ–¹æ³•
  websocket.onclose = function () {
    setMessageInnerHTML("WebSocketè¿æ¥å…³é—­");
  }

  //ç›‘å¬çª—å£å…³é—­äº‹ä»¶ï¼Œå½“çª—å£å…³é—­æ—¶ï¼Œä¸»åŠ¨å»å…³é—­websocketè¿æ¥ï¼Œé˜²æ­¢è¿æ¥è¿˜æ²¡æ–­å¼€å°±å…³é—­çª—å£ï¼Œserverç«¯ä¼šæŠ›å¼‚å¸¸ã€‚
  window.onbeforeunload = function () {
    closeWebSocket();
  }

  //å°†æ¶ˆæ¯æ˜¾ç¤ºåœ¨ç½‘é¡µä¸Š
  function setMessageInnerHTML(innerHTML) {
    let pre = document.createElement("pre");
    pre.innerText = innerHTML;
    div.append(pre);
    div.scrollTop = div.scrollHeight;
  }

  //å…³é—­WebSocketè¿æ¥
  function closeWebSocket() {
    websocket.close();
  }

  //å‘é€æ¶ˆæ¯
  function send() {
    var message = document.getElementById('text').value;
    websocket.send('{"msg":"' + message + '"}');
    setMessageInnerHTML("send server message: " + message);
  }
  // å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯
  function handleMessage(message) {
    if ((/^\{.*}$/).test(message)) {
      let data = JSON.parse(message).msg;
      return data;
    } else {
      return message;
    }
  }
</script>

<script>
  const backEnv = ['dev', 'prod', 'aliyun', 'preview', 'beijing']
  const webEnv = ['dev', 'prod', 'aliyun', 'preview', 'beijing']
  const appEnv = ['dev', 'prod', 'aliyun', 'preview', 'beijing']
  const appList = ['digital-back', 'digital-web', 'digital-app']
  function getData() {
    $.ajax({
      url: `http://localhost:8080/api/cors`,
      method: "get"
    }).then((data) => {
      console.log(data);
    })
  }
  function runApp(data) {
    let application;
    let environment;
    let operation;
    div.innerHTML = "";
    if (!appList.includes(data)) {
      alert("éæ³•å‚æ•°");
      return;
    }
    if (data === "digital-back") {
      const back = document.querySelector("[name='digital-back']");
      if (back.value && backEnv.includes(back.value)) {
        environment = back.value;
      }
    } else if (data === 'digital-web') {
      const web = document.querySelector("[name='digital-web']");
      if (web.value && webEnv.includes(web.value)) {
        environment = web.value;
      }
    } else if (data === 'digital-app') {
      const app = document.querySelector("[name='digital-app']");
      if (app.value && appEnv.includes(app.value)) {
        environment = app.value;
      }
    }
    if (!environment) {
      alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåˆ†æ”¯");
      return;
    }
    if (event.target.getAttribute('data')) {
      operation = event.target.getAttribute("data");
    }
    application = data;
    const param = {
      application,
      environment,
      operation

    }
    fetch(`/ops/runApp/${userId}`, {
      header: {
        "content-type": "application/json;charset=utf-8;"
      },
      method: "POST",
      data: JSON.stringify(param)
    })
      .then(res => res.json())
      .then(json => alert(json.msg))
      .catch(e => alert(e.message));
  }
</script>

</html>
